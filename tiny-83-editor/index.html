<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Editor for TINY-83</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Helvetica">
    <script language="javascript" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="https://unpkg.com/@metamask/detect-provider/dist/detect-provider.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
    body {
      text-align: center;
      font-family: Arial;
      background-color: #ececec;
    }

    * {
      font-family: Arial;
      color: grey;
    }

    /* Styles title */
    h1 {
      font-size: 2em;
      text-transform: uppercase;
    }

    table,
    tr,
    td {
      border: white 1px dotted;
    }

    table {
      border-collapse: collapse;
    }

    tr {
      height: 20px;
    }

    td {
      min-width: 20px;
      box-sizing: border-box;
      background-color: #c9ddc9;
    }

    .new-button {
    	border-radius: 7px;
    	border: 1px solid #dcdcdc;
    	font-weight: bold;
    	padding: 6px 24px;
    	text-decoration: none;
      display: block;
      margin-top: 1em;
    }

    .inputs {
      text-align: left;
      border-radius: 7px;
      border: 1px solid #dcdcdc;
      padding-left: 2em;
      padding-top: 0.5em;
      padding-bottom: 1.5em;
      background-color : white;
    }

    .row {
      display: block;
      margin-right: auto;
      margin-left: auto;
      max-width: 500px;
    }

    .pixel-canvas {
      margin-left: auto;
      margin-right: auto;
    }
    </style>

  </head>
  <body>
    <div class="row">
        <h1>Editor for TINY-83</h1>
        <table class="pixel-canvas"></table>
        <br>
        <div class="inputs">
          <input type="button" class="new-button" value="New">
          <p>Hint: Click to draw, double-click to erase</p>
          Copy and paste this screen code in <a href="https://tiny-83.github.io/tiny-83/">tiny-83</a>:
          <input class="input-code" id="input-code" name="code" size="50" value="0, 0">
          <br><br>
          Like this? Tip me ETH :-)
          <button class="tip-button new-button">Tip <i class="fa fa-heart" style="color:red"></i></button>
          <div class="message"></div>
        </div>
      </div>
    </div>
  </body>
  <script>
  const pixelCanvas = document.querySelector('.pixel-canvas');
  const newButton = document.querySelector('.new-button');
  const color = "#4b5a4b";
  const bgColor = "#c9ddc9";

  const gridWidth = 22;
  const gridHeight = 14;
  let grid = [];

  function resetGrid() {
    grid = [];
    for (let i = 0; i < gridHeight; i++) {
      const row = [];
      for (let j = 0; j < gridWidth; j++) {
        row.push(false);
      }
      grid.push(row);
    }
  }

  function gridToPairOfUint160() {
    let gridR = grid.map((val, index) => [grid].map(row => row[index]).reverse());
    grid2R = gridR[0].map((val, index) => gridR.map(row => row[index]).reverse())[0];
    let leftPart = 0n;
    let rightPart = 0n;
    for (let i = 0; i < gridHeight; i++) {
      for (let j = 0; j < gridWidth; j++) {
        const power = BigInt(13 - i) + 14n * BigInt(j % 11);
        const diff = grid2R[i][j] ? (2n ** power) : 0n;
        if (j < 11) {
          leftPart += diff;
        } else {
          rightPart += diff;
        }
      }
    }
    leftCode = leftPart.toString();
    rightCode = rightPart.toString();
    let inputCode = document.getElementById("input-code");
    inputCode.value = `${leftCode}, ${rightCode}`;
  }

  function makeGrid() {
    resetGrid()
    // If grid already present, clears any cells that have been filled in
    while (pixelCanvas.firstChild) {
      pixelCanvas.removeChild(pixelCanvas.firstChild);
      }
    // Creates rows and cells
    for (let i = 0; i < gridHeight; i++) {
      let gridRow = document.createElement('tr');
      pixelCanvas.appendChild(gridRow);
      for (let j = 0; j < gridWidth; j++) {
        let gridCell = document.createElement('td');
        gridCell.setAttribute("x", i);
        gridCell.setAttribute("y", j);
        gridRow.appendChild(gridCell);
        // Fills in cell with selected color upon mouse press ('mousedown', unlike 'click', doesn't also require release of mouse button)
        gridCell.addEventListener('mousedown', function() {
          this.style.backgroundColor = color;
          grid[this.getAttribute("x")][this.getAttribute("y")] = true;
          gridToPairOfUint160();
        })
       }
    }
  }

  makeGrid();

  // Enables color dragging with selected color (code for filling in single cell is above). (No click on 'draw' mode needed; this is default mode)
  let down = false; // Tracks whether or not mouse pointer is pressed

  // Listens for mouse pointer press and release on grid. Changes value to true when pressed, but sets it back to false as soon as released
  pixelCanvas.addEventListener('mousedown', function(e) {
  	down = true;
  	pixelCanvas.addEventListener('mouseup', function() {
  		down = false;
  	});
    // Ensures cells won't be colored if grid is left while pointer is held down
    pixelCanvas.addEventListener('mouseleave', function() {
      down = false;
    });

    pixelCanvas.addEventListener('mouseover', function(e) {
      // 'color' defined here rather than globally so JS checks whether user has changed color with each new mouse press on cell
      // While mouse pointer is pressed and within grid boundaries, fills cell with selected color. Inner if statement fixes bug that fills in entire grid
    	if (down) {
        // 'TD' capitalized because element.tagName returns upper case for DOM trees that represent HTML elements
        if (e.target.tagName === 'TD') {
        	e.target.style.backgroundColor = color;
          grid[e.target.getAttribute("x")][e.target.getAttribute("y")] = true;
          gridToPairOfUint160();
        }
      }
    });
  });

  // Adds color-fill functionality. e.preventDefault(); intercepts page refresh on button click
  newButton.addEventListener('click', function(e) {
    resetGrid();
    e.preventDefault();
    pixelCanvas.querySelectorAll('td').forEach(td => td.style.backgroundColor = bgColor);
    gridToPairOfUint160();
  });

  // Removes color from cell upon double-click
  pixelCanvas.addEventListener('dblclick', e => {
    e.target.style.backgroundColor = bgColor;
    grid[e.target.getAttribute("x")][e.target.getAttribute("y")] = false;
    gridToPairOfUint160();
  });


$(document).ready(function () {
    if (window.ethereum != null) {
      ethereum.on('accountsChanged', handleAccountsChanged);
      setTimeout(connect, 500);
      start();
    }
});

let web3 = null;
let currentAccount = null;

async function start() {
    const provider = await detectEthereumProvider();
    if (provider) {
        // If the provider returned by detectEthereumProvider is not the same as
        // window.ethereum, something is overwriting it, perhaps another wallet.
        if (provider !== window.ethereum) {
            renderMessage('Do you have multiple wallets installed?');
        }
        web3 = new Web3(provider);
    } else {
        renderMessage("Please install the MetaMask extension and connect your wallet.");
    }
}

function connect() {
    ethereum
        .request({ method: 'eth_requestAccounts' })
        .then(handleAccountsChanged)
        .catch((err) => {
            if (err.code === 4001) {
                // EIP-1193 userRejectedRequest error.
                console.warn('Connect to MetaMask.');
            } else {
                console.error(err);
            }
        });
}

function handleAccountsChanged(accounts) {
    if (accounts.length === 0) {
        console.log("MetaMask is locked or you haven't connected any account. Please connect to MetaMask.");
        $(".mint button").hide();
    } else if (accounts[0] !== currentAccount) {
        currentAccount = accounts[0];
        $(".mint button").show();
    }
}

var my_address = '0x525aA4419FfDF242220E2954610C91172a3fA925'
var tipButton = document.querySelector('.tip-button')

tipButton.addEventListener('click', function() {

  if (!web3) {
    return renderMessage('<div align="center">You need to install <a href="https://metamask.io/"><u>MetaMask</u></a> to use this.</a></div>')
  } else {
    // Request account access if needed
    ethereum.enable().then(function () {
      // Acccounts now exposed
      web3.eth.sendTransaction({
        to: my_address,
        from: currentAccount,
        value: Web3.utils.toWei('0.01', 'ether'),
      }, function (err, transactionHash) {
        if (err) return renderMessage('There was a problem: ' + err.message)
        renderMessage('Thanks for your generosity!')
      })
    });
  }

})

function renderMessage (message) {
  var messageEl = document.querySelector('.message')
  messageEl.innerHTML = message
}
  </script>
</html>
